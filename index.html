<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>XROBO BLE â€” Voice Edition</title>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<script src="https://unpkg.com/blockly/blockly.min.js"></script>
<style>
  :root{
    --pad:10px;
    --uiScale: 1;
    --headerH: 64px;
    --btnH: 36px;

    --gap: 8px;
    --headerBgTop: #fff7ed;
    --headerBgBottom: #fffbeb;
    --headerBorder: #fed7aa;
    --logH: 180px;
    --blue: #1d4ed8;

    --handleWBase: 22;
    --handleHBase: 28;
    --triWBase:   14;
    --triHBase:   12;

    --handleW: calc(var(--handleWBase) * var(--uiScale) * 1px);
    --handleH: calc(var(--handleHBase) * var(--uiScale) * 1px);
    --triW:    calc(var(--triWBase)    * var(--uiScale) * 1px);
    --triH:    calc(var(--triHBase)    * var(--uiScale) * 1px);
    --linkBar: calc(3 * var(--uiScale) * 1px);

    --keyW: clamp(52px, 8vmin, 92px);
    --keyH: calc(var(--keyW) * 2.7);
    --keyGap: 6px;
    --keyFont: 14px;

    --eyesGap: 8vmin;
    --eyeSize: 42vmin;
    --pupilSize: 16vmin;
    --blinkSpeed: 180ms;
  }
  @media (max-width: 480px){
    :root{ --keyGap: 4px; --keyFont: 13px; }
  }

  *{ box-sizing:border-box; }
  html, body{ height:100%; }
  body{ margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#fff; }

  /* â”€â”€ í—¤ë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  header{
    padding: 8px 12px;
    background: linear-gradient(180deg, var(--headerBgTop), var(--headerBgBottom));
    border-bottom: 1px solid var(--headerBorder);
    position:relative; z-index:10;
  }
  #topbar{
    display:flex; align-items:center; gap: calc(var(--gap) * var(--uiScale));
    flex-wrap: wrap;
  }
  .title{
    font-weight: 800; letter-spacing: .2px;
    color:#7c2d12; margin-right: 12px;
    font-size: calc(18px * var(--uiScale));
  }
  .spacer{ flex: 1 1 auto; }

  .btn{
    height: calc(var(--btnH) * var(--uiScale));
    padding: 0 calc(12px * var(--uiScale));
    border:0; border-radius: calc(10px * var(--uiScale));
    display:inline-flex; align-items:center; justify-content:center;
    font-size: calc(14px * var(--uiScale)); font-weight:600;
    box-shadow:0 2px 8px rgba(0,0,0,.08);
    background:#f3f4f6; color:#111827; cursor:pointer;
    user-select:none;
  }
  .btn.small{ height: calc(var(--btnH) * var(--uiScale) * .85); padding: 0 calc(10px * var(--uiScale)); font-size: calc(12px * var(--uiScale)); }
  #connectToggle{ background:#2563eb; color:#fff; }
  #testBtn{ background:#0ea5e9; color:#fff; }
  #runToggle{ background:#16a34a; color:#fff; }
  #fsBtn{ background:#111827; color:#fff; }

  .state{
    display:inline-flex; align-items:center; gap:calc(6px * var(--uiScale));
    height: calc(var(--btnH) * var(--uiScale));
    padding: 0 calc(6px * var(--uiScale));
    font-size: calc(12px * var(--uiScale));
  }
  .badgeDot{
    width: calc(22px * var(--uiScale));
    height: calc(22px * var(--uiScale));
    border-radius: 50%;
    display:inline-flex; align-items:center; justify-content:center;
    font-size: calc(11px * var(--uiScale));
    font-weight:800; color:#fff;
    box-shadow: 0 0 0 calc(4px * var(--uiScale)) rgba(0,0,0,.06) inset;
  }
  .badgeDot.on{ background:#3b82f6; }
  .badgeDot.off{ background:#ef4444; }

  /* â”€â”€ ë ˆì´ì•„ì›ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #main{ display:flex; width:100%; height: calc(100vh - var(--headerH)); }
  #left{ position:relative; flex:1 1 auto; min-width:0; height:100%; display:flex; overflow:visible; }
  #blocklyDiv{ flex:1 1 auto; min-width:0; height:100%; width:100%; }

  #right{
    flex:0 0 40%; display:flex; flex-direction:column; background:#fff;
    margin:8px 8px 8px 0; border:1px solid #e5e7eb; border-left:3px solid var(--blue);
    border-radius:12px 0 0 12px; box-shadow:0 2px 10px rgba(0,0,0,.04); overflow:hidden;
    position:relative;
  }

  /* â”€â”€ ìš°ì¸¡ ìƒë‹¨: ìì´ë¡œ íŒ¨ë„ â”€â”€ */
  #rightTop{
    flex:1 1 auto; border-bottom:1px solid #e5e7eb; min-height: 120px;
    background:#020617; color:#fff;
    display:flex; align-items:center; justify-content:center;
    padding: 0; overflow:hidden;
  }
  .voiceWrap{
    position:relative;
    width:100%; height:100%;
    display:flex; align-items:center; justify-content:center;
    padding:16px;
    background: radial-gradient(circle at 0% 0%, #1f2937 0, #020617 52%, #000 100%);
  }

  /* === ìì´ë¡œ ê³µ UI === */
  .gyro-panel{
    width:100%;
    height:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:12px;
    color:#e5e7eb;
  }
  .gyro-area{
    position:relative;
    /* í™”ë©´ í¬ê¸°ì— ë¹„ë¡€í•˜ë„ë¡ vmin + ì»¨í…Œì´ë„ˆ ë¹„ìœ¨ ì‚¬ìš© */
    width:min(70vmin, 90%);
    max-width:360px;
    aspect-ratio:1/1;
    border-radius:24px;
    border:1px solid rgba(148,163,184,.6);
    background:
      radial-gradient(circle at 50% 18%, rgba(59,130,246,.5), transparent 60%),
      radial-gradient(circle at 50% 100%, rgba(15,23,42,.9), #020617);
    box-shadow:0 16px 40px rgba(0,0,0,.7);
    overflow:hidden;
  }
  .gyro-ball{
    position:absolute;
    left:50%; top:50%;
    width:18%; height:18%;
    border-radius:50%;
    background: radial-gradient(circle at 30% 20%, #93c5fd, #2563eb);
    box-shadow:0 10px 20px rgba(15,23,42,.9);
    transform:translate(-50%,-50%);
    transition: transform 80ms linear;
  }
  .gyro-target{
    position:absolute;
    width:36%; height:36%;
    border-radius:50%;
    border:2px dashed rgba(148,163,184,.7);
    background:radial-gradient(circle, rgba(15,23,42,.6) 0, transparent 60%);
    box-shadow:0 0 0 1px rgba(15,23,42,.8) inset;
  }
  .gyro-target-front{ top:6%; left:50%; transform:translateX(-50%); }
  .gyro-target-back{ bottom:6%; left:50%; transform:translateX(-50%); }
  .gyro-target-left{ left:6%; top:50%; transform:translateY(-50%); }
  .gyro-target-right{ right:6%; top:50%; transform:translateY(-50%); }
  .gyro-target.active{
    border-color:#60a5fa;
    box-shadow:0 0 0 3px rgba(37,99,235,.5) inset;
  }
  .gyro-btn{
    position:absolute;
    top:8px;
    width:36px;
    height:28px;
    border-radius:999px;
    border:0;
    font-size:14px;
    font-weight:700;
    background:rgba(15,23,42,.85);
    color:#f9fafb;
    cursor:pointer;
    box-shadow:0 6px 12px rgba(0,0,0,.7);
  }
  .gyro-btn-1{ left:8px; }
  .gyro-btn-2{ right:8px; }
  .gyro-btn:active{
    transform:translateY(1px);
    box-shadow:0 3px 8px rgba(0,0,0,.8);
  }
  .gyro-info{
    font-size:12px;
    text-align:center;
    opacity:.9;
  }
  .gyro-status{
    margin-bottom:4px;
    color:#93c5fd;
    font-weight:600;
  }
  .gyro-event-text{
    display:inline-block;
    margin-top:4px;
    padding:4px 10px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.8);
    background:rgba(15,23,42,.25);
    font-size:13px;
    font-weight:600;
    color:#e5e7eb;
    min-width:70px;
  }
  .gyro-hint{
    margin-top:6px;
    font-size:11px;
    color:#6b7280;
  }
  .gyro-panel-overlay .gyro-area{
    /* ì „ì²´ í™”ë©´ì—ì„œëŠ” í›¨ì”¬ í¬ê²Œ ë³´ì´ë„ë¡ px ì œí•œ ì œê±° */
    max-width:none;
    width:min(80vmin, 90vw, 90vh);
  }
  .gyro-panel-overlay .gyro-info{
    margin-top:14px;
    font-size:14px;
  }

  /* ë¦¬ì‚¬ì´ì € ë°” (ë¡œê·¸/ìœ„ íŒ¨ë„ ë†’ì´ ì¡°ì ˆ) */
  #rightDivider{
    flex:0 0 6px;
    cursor: row-resize;
    background: repeating-linear-gradient(90deg, #d1d5db 0, #d1d5db 6px, #e5e7eb 6px, #e5e7eb 12px);
  }

  /* ë¡œê·¸ íŒ¨ë„ */
  #rightBottom{
    flex: 0 0 var(--logH);
    display:flex; flex-direction:column; min-height:0; overflow:hidden;
    padding: calc(10px * var(--uiScale));
    background:#0b0f14; color:#d1e4ff; border-top:1px solid #1f2937;
  }
  #log{
    flex:1 1 0; min-height:0; overflow:auto; white-space:pre-wrap;
    background:#0b0f14; border:1px solid #1f2937; border-radius: calc(8px * var(--uiScale));
    padding: calc(10px * var(--uiScale));
    font-family: ui-monospace, Menlo, Consolas, monospace;
    font-size: calc(12px * var(--uiScale)); color:#d1e4ff;
  }

  #panelHandle{
    position:absolute; top: calc(12px * var(--uiScale)); right: 0;
    z-index:999; width: var(--handleW); height: var(--handleH);
    background: var(--blue); border: 0; border-radius: calc(6px * var(--uiScale));
    box-shadow: 0 2px 8px rgba(0,0,0,.18); cursor: pointer; padding: 0;
  }
  #panelHandle::before{
    content:''; position:absolute; top:0; right: calc(0px - var(--linkBar));
    width: var(--linkBar); height:100%; background: var(--blue);
    border-top-right-radius: calc(6px * var(--uiScale)); border-bottom-right-radius: calc(6px * var(--uiScale));
  }
  #panelHandle::after{
    content:''; position:absolute; top:50%; transform: translateY(-50%);
    width:0; height:0; border-style: solid;
  }
  #panelHandle.open::after{
    left: calc((var(--handleW) - var(--triW)) / 2);
    border-width: var(--triH) 0 var(--triH) var(--triW);
    border-color: transparent transparent transparent white;
  }
  #panelHandle.closed::after{
    left: calc((var(--handleW) - var(--triW)) / 2);
    border-width: var(--triH) var(--triW) var(--triH) 0;
    border-color: transparent white transparent transparent;
  }
  .blocklyZoom,.blocklyTrash{ display:block !important; }
  .blocklyTrashLid, .blocklyTrashcanLid, .blocklyTrashCanLid { display:none !important; }

  body.fs-active #main{ height: calc(100vh - var(--headerH)); }
  body.panel-collapsed #right{ display:none; }
  body.panel-collapsed #left{ flex:1 1 100%; }

  /* â”€â”€ ì „ì²´í™”ë©´ ì˜¤ë²„ë ˆì´(ìì´ë¡œ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #playOverlay{
    position:fixed; inset:0; background:#000; color:#fff; display:none; z-index:10000;
    touch-action:none; overscroll-behavior:contain; -webkit-tap-highlight-color:transparent;
  }
  #playOverlay.show{ display:flex; flex-direction:column; }
  #playOverlay .body{
    flex:1 1 auto;
    display:flex; align-items:center; justify-content:center;
    background:#020617;
  }
  #overlayGyroWrap{
    width:100%; max-width:480px;
  }

  /* === íŒŒì¼ ë“œë¡­ë‹¤ìš´ === */
  .dropdown{ position:relative; }
  .dropdown .menu{
    position:absolute; right:0; top:calc(100% + 4px);
    display:none; min-width:140px;
    background:#ffffff; border:1px solid #d1d5db; border-radius:8px;
    box-shadow:0 6px 16px rgba(0,0,0,.12); padding:6px; z-index:1000;
  }
  .dropdown .menu.show{ display:block; }
  .dropdown .menu > button{
    width:100%; background:transparent; border:0; cursor:pointer;
    padding:8px 10px; border-radius:6px;
    font-size:calc(13px * var(--uiScale));
    text-align:left; color:#111827;
  }
  .dropdown .menu > button:hover{ background:#f3f4f6; }
  #fileBtn{ background:#6b7280; color:#ffffff; }
</style>

<style id="xrobo-hsplit-style">
  :root{ --rightW: 40%; } /* initial right width */
  #hResizer{
    flex: 0 0 8px;
    background: linear-gradient(90deg,#e5e7eb,#d1d5db);
    border-left: 1px solid #cbd5e1;
    border-right: 1px solid #cbd5e1;
    cursor: col-resize;
    touch-action: none;
    margin: 8px 0;
  }
  body.hs-resizing, body.hs-resizing *{ cursor: col-resize !important; user-select: none !important; }
  #right{ flex: 0 0 var(--rightW) !important; width: var(--rightW) !important; min-width: 0 !important; }
</style>
<style id="single-change-hide-handle">
  #panelHandle { display: none !important; }
</style>

<style id="xrobo-kp4x4-v14-style">
  :root { --xroboKpScale: .7; }
  #xrobo-kp4x4-v14{
    position:absolute; left:0; top:0; display:none; z-index:2147483647;
    background:#000; border:2px solid #000; border-radius:calc(16px * var(--xroboKpScale));
    padding: calc(12px * var(--xroboKpScale)); box-shadow:0 16px 46px rgba(0,0,0,.45);
    user-select:none; touch-action:manipulation;
  }
  #xrobo-kp4x4-v14.show{ display:block; }
  #xrobo-kp4x4-v14 .display{
    margin-bottom:calc(10px * var(--xroboKpScale)); background:#0b0f14; color:#e5e7eb;
    border:1px solid #1f2937; border-radius:calc(10px * var(--xroboKpScale));
    padding:calc(10px * var(--xroboKpScale)) calc(12px * var(--xroboKpScale));
    font-weight:800; font-size:calc(18px * var(--xroboKpScale)); letter-spacing:.6px; min-height:24px;
  }
  #xrobo-kp4x4-v14 .grid{
    display:grid; grid-template-columns: repeat(4, calc(56px * var(--xroboKpScale)));
    grid-auto-rows: calc(56px * var(--xroboKpScale));
    gap: calc(10px * var(--xroboKpScale));
  }
  #xrobo-kp4x4-v14 button{
    border:0; border-radius:calc(12px * var(--xroboKpScale)); background:#fff; color:#111;
    font-weight:900; font-size:calc(20px * var(--xroboKpScale));
    box-shadow:0 calc(4px * var(--xroboKpScale)) calc(14px * var(--xroboKpScale)) rgba(0,0,0,.22);
    cursor:pointer;
  }
  #xrobo-kp4x4-v14 button:active{ transform:translateY(1px); }
  #xrobo-kp4x4-v14 .op{ background:#e6eefc; color:#0b3aa6; font-weight:800; }
  #xrobo-kp4x4-v14 .back{ background:#111827; color:#fff; font-size:calc(18px * var(--xroboKpScale)); }
  #xrobo-kp4x4-v14 .clear{ background:#e5e7eb; color:#111827; font-size:calc(16px * var(--xroboKpScale)); font-weight:800; }
  #xrobo-kp4x4-v14 .wide{ grid-column: span 2; height:calc(56px * var(--xroboKpScale)); font-size:calc(18px * var(--xroboKpScale)); font-weight:800; }
  #xrobo-kp4x4-v14 .ok{ background:#2563eb; color:#fff; }
  #xrobo-kp4x4-v14 .cancel{ background:#6b7280; color:#fff; }
</style>
</head>
<body>
  <!-- í—¤ë” -->
  <header id="appHeader">
    <div id="topbar">
      <div class="title">XROBO BLE â€” ìŒì„± ëª…ë ¹</div>
      <div class="spacer"></div>

      <!-- íŒŒì¼ ë“œë¡­ë‹¤ìš´ -->
      <div class="dropdown" id="fileDropdown">
        <button id="fileBtn" class="btn" title="íŒŒì¼">íŒŒì¼ â–¾</button>
        <div id="fileMenu" class="menu" role="menu" aria-hidden="true">
          <button data-cmd="new" role="menuitem">ìƒˆë¡œë§Œë“¤ê¸°</button>
          <button data-cmd="save" role="menuitem">ì €ì¥í•˜ê¸°</button>
          <button data-cmd="load" role="menuitem">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
      </div>

      <span class="state"><span id="statusDot" class="badgeDot off">off</span></span>
      <button id="connectToggle" class="btn">ì—°ê²°</button>

      <!-- í…ŒìŠ¤íŠ¸/ì‹¤í–‰ -->
      <button id="testBtn" class="btn" title="ì½”ë”© í™”ë©´ì—ì„œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰">í…ŒìŠ¤íŠ¸</button>
      <button id="runToggle" class="btn" title="ì „ì²´í™”ë©´ ì‹¤í–‰">ì‹¤í–‰</button>

      <button id="fsBtn" class="btn" title="ì „ì²´í™”ë©´">ì „ì²´í™”ë©´</button>
    </div>
  </header>

  <!-- ë³¸ë¬¸ -->
  <div id="main">
    <div id="left">
      <div id="blocklyDiv"></div>
      <button id="panelHandle" class="open" title="ì‹¤í–‰ì°½ ë‹«ê¸°"></button>
    </div>
    <div id="hResizer" class="hsplit" title="ì¢Œìš° í¬ê¸° ì¡°ì ˆ ë°”"></div>

    <div id="right">
      <!-- ìš°ì¸¡ ìƒë‹¨: ìì´ë¡œ íŒ¨ë„ -->
      <div id="rightTop">
        <div class="voiceWrap" id="voiceWrap">
          <div id="gyroPanel" class="gyro-panel">
            <div id="gyroArea" class="gyro-area">
              <div id="gyroTargetFront" class="gyro-target gyro-target-front"></div>
              <div id="gyroTargetBack" class="gyro-target gyro-target-back"></div>
              <div id="gyroTargetLeft" class="gyro-target gyro-target-left"></div>
              <div id="gyroTargetRight" class="gyro-target gyro-target-right"></div>
              <div id="gyroBall" class="gyro-ball"></div>
              <button id="gyroBtn1" class="gyro-btn gyro-btn-1">1</button>
              <button id="gyroBtn2" class="gyro-btn gyro-btn-2">2</button>
            </div>
            <div class="gyro-info">
              <div id="gyroStatus" class="gyro-status">
                í…ŒìŠ¤íŠ¸í•˜ê¸° ì „ì— ìì´ë¡œ ì„¼ì„œ í™”ë©´ì— ìˆ˜í‰ì„ ë§ì¶”ê³  í…ŒìŠ¤íŠ¸ë‚˜ ì‹¤í–‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.
              </div>
              <div id="gyroEventText" class="gyro-event-text">ëŒ€ê¸° ì¤‘</div>
            </div>
          </div>
        </div>
      </div>

      <div id="rightDivider" title="ë“œë˜ê·¸í•˜ì—¬ ë¡œê·¸ ë†’ì´ ì¡°ì ˆ"></div>
      <div id="rightBottom">
        <div style="font-size:calc(12px * var(--uiScale));color:#9ca3af;">ì‹¤í–‰ ë¡œê·¸</div>
        <div id="log"></div>
      </div>
    </div>
  </div>

  <!-- íˆ´ë°•ìŠ¤ -->
  <xml id="toolbox" style="display:none">
    <category name="ì´ë²¤íŠ¸" colour="#f59e0b">
      <block type="xrobo_start"></block>
    </category>
    <category name="ì¶œë ¥" colour="#60a5fa">
      <block type="motor12_dd">
        <field name="M1">20</field><field name="M2">20</field><field name="MS">500</field>
      </block>
      <block type="motor12_in">
        <value name="M1"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
        <value name="M2"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
        <value name="MS"><shadow type="math_number"><field name="NUM">500</field></shadow></value>
      </block>
      <block type="melody">
        <field name="PITCH">C4</field>
        <value name="DUR"><shadow type="math_number"><field name="NUM">200</field></shadow></value>
        <value name="WAIT"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
      </block>
      <block type="led_ctrl">
        <field name="TGT">OUT1</field>
        <field name="MODE">BRIGHT</field>
        <field name="VAL">10</field>
      </block>
    </category>
    <category name="ì œì–´" colour="#10b981">
      <block type="controls_repeat_ext">
        <value name="TIMES"><shadow type="math_number"><field name="NUM">3</field></shadow></value>
      </block>
      <block type="wait_seconds">
        <value name="SEC"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
      </block>
    </category>
  </xml>

  <!-- ì „ì²´í™”ë©´ ì˜¤ë²„ë ˆì´: ìì´ë¡œ UI -->
  <div id="playOverlay" aria-hidden="true">
    <div class="body">
      <div id="overlayGyroWrap" class="voiceWrap">
        <div id="overlayGyroPanel" class="gyro-panel gyro-panel-overlay">
          <div id="overlayGyroArea" class="gyro-area">
            <div id="overlayGyroTargetFront" class="gyro-target gyro-target-front"></div>
            <div id="overlayGyroTargetBack" class="gyro-target gyro-target-back"></div>
            <div id="overlayGyroTargetLeft" class="gyro-target gyro-target-left"></div>
            <div id="overlayGyroTargetRight" class="gyro-target gyro-target-right"></div>
            <div id="overlayGyroBall" class="gyro-ball"></div>
            <button id="overlayGyroBtn1" class="gyro-btn gyro-btn-1">1</button>
            <button id="overlayGyroBtn2" class="gyro-btn gyro-btn-2">2</button>
          </div>
          <div class="gyro-info">
            <div id="overlayGyroStatus" class="gyro-status">
              í…ŒìŠ¤íŠ¸í•˜ê¸° ì „ì— ìì´ë¡œ ì„¼ì„œ í™”ë©´ì— ìˆ˜í‰ì„ ë§ì¶”ê³  í…ŒìŠ¤íŠ¸ë‚˜ ì‹¤í–‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.
            </div>
            <div id="overlayGyroEventText" class="gyro-event-text">ëŒ€ê¸° ì¤‘</div>
            <div class="gyro-hint">íŒíŠ¸: í™”ë©´ì„ ë‘ ë²ˆ íƒ­í•˜ë©´ ì‹¤í–‰ì´ ì¢…ë£Œë©ë‹ˆë‹¤.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ================= Blockly ê¸°ë³¸ ì„¤ì • ================= */
class XroboZelosProvider extends Blockly.zelos.ConstantProvider {
  constructor(){ super(); this.ADD_START_HATS = true; }
}
class XroboZelosRenderer extends Blockly.zelos.Renderer {
  constructor(){ super('xrobo_zelos'); }
  makeConstants_(){ return new XroboZelosProvider(); }
}
Blockly.blockRendering.register('xrobo_zelos', XroboZelosRenderer);
const XroboTheme = Blockly.Theme.defineTheme('xrobo_theme', {
  base: Blockly.Themes.Zelos,
  componentStyles: { startHats: true }
});

var ws = Blockly.inject('blocklyDiv', {
  toolbox: document.getElementById('toolbox'),
  renderer: 'xrobo_zelos',
  theme: XroboTheme,
  grid: { spacing:20, length:3, colour:'#eee', snap:true },
  zoom: { controls:true, wheel:true, startScale:1, minScale:0.5, maxScale:2 },
  move: { scrollbars:true, drag:true, wheel:true },
  trashcan: true
});

/* â–¼â–¼ Blockly v12 ë³€ìˆ˜ API ê²½ê³  ì œê±°ìš© SHIM â–¼â–¼ */
(function patchBlocklyDeprecated(){
  try{
    if (Blockly.Workspace && Blockly.Workspace.prototype && Blockly.Workspace.prototype.getAllVariables) {
      Blockly.Workspace.prototype.getAllVariables = function(){
        var vm = this.getVariableMap ? this.getVariableMap() : null;
        return (vm && vm.getAllVariables) ? vm.getAllVariables() : [];
      };
    }
  }catch(e){}
})();
/* â–²â–² SHIM ë â–²â–² */

/* ë“œë˜ê·¸ ì¤‘ ìë™ ìŠ¤í¬ë¡¤ ë°©ì§€ */
(function disableAutoScrollWhileBlockDragging(){
  try{
    if (Blockly.BlockDragger && Blockly.BlockDragger.prototype) {
      var orig = Blockly.BlockDragger.prototype.updateDrag;
      if (typeof orig === 'function') {
        Blockly.BlockDragger.prototype.updateDrag = function(e){
          var saved = this.autoScroll_;
          this.autoScroll_ = null;
          var r = orig.call(this, e);
          this.autoScroll_ = saved;
          return r;
        };
      }
    }
  }catch(e){ console.warn('AutoScroll patch failed', e); }
})();

/* ================= ìƒìˆ˜/ê³µìš© ================= */
var PINS_OUT=[["OUT1","OUT1"],["OUT2","OUT2"],["OUT3","OUT3"],["OUT4","OUT4"],["OUT5","OUT5"],["OUT6","OUT6"],["OUT7","OUT7"],["OUT8","OUT8"]];
var SPEEDS=Array.from({length:41},(_,i)=>20-i).map(v=>[String(v),String(v)]);
var TIMES100=Array.from({length:10},(_,i)=>100*(i+1)).map(v=>[String(v),String(v)]);
var LED_TGT=[].concat(PINS_OUT,[["CPU","CPU"]]);
var LED_MODE=[["ë°ê¸°","BRIGHT"],["ìˆ¨ì‰¬ê¸°","BREATHE"]];
var LED_VALS=Array.from({length:20},(_,i)=>[String(i),String(i)]);

/* ìì´ë¡œ ì´ë²¤íŠ¸ ì˜µì…˜: ë“œë¡­ë‹¤ìš´ + ë¼ë²¨ ë§¤í•‘ */
var GYRO_EVENT_OPTIONS = [
  ["ì•ìª½ìœ¼ë¡œ ê¸°ìš¸ë©´","tilt_front"],
  ["ë’¤ìª½ìœ¼ë¡œ ê¸°ìš¸ë©´","tilt_back"],
  ["ì™¼ìª½ìœ¼ë¡œ ê¸°ìš¸ë©´","tilt_left"],
  ["ì˜¤ë¥¸ìª½ìœ¼ë¡œ ê¸°ìš¸ë©´","tilt_right"],
  ["1ë²ˆ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´","btn1"],
  ["2ë²ˆ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´","btn2"]
];
var GYRO_EVENT_LABELS = {};
GYRO_EVENT_OPTIONS.forEach(function(opt){
  GYRO_EVENT_LABELS[opt[1]] = opt[0];
});

/* ================= ë¸”ë¡ ì •ì˜ ================= */
Blockly.defineBlocksWithJsonArray([
  {
    "type":"xrobo_start",
    "message0":"%1 ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´",
    "args0":[
      { "type":"field_dropdown","name":"EVT","options":GYRO_EVENT_OPTIONS }
    ],
    "nextStatement":null,
    "colour":36,
    "hat":"cap"
  },
  {
    "type":"motor12_dd",
    "message0":"ëª¨í„° M1 %1  M2 %2  ì‹œê°„ %3 ms",
    "args0":[
      {"type":"field_dropdown","name":"M1","options":SPEEDS},
      {"type":"field_dropdown","name":"M2","options":SPEEDS},
      {"type":"field_dropdown","name":"MS","options":TIMES100}
    ],
    "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":210
  },
  {
    "type":"motor12_in",
    "message0":"ëª¨í„° M1 %1  M2 %2  ì‹œê°„ %3 ms",
    "args0":[
      {"type":"input_value","name":"M1","check":"Number"},
      {"type":"input_value","name":"M2","check":"Number"},
      {"type":"input_value","name":"MS","check":"Number"}
    ],
    "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":210
  },
  {
    "type":"melody",
    "message0":"ë©œë¡œë”” ìŒë†’ì´ %1 ì†Œë¦¬ì‹œê°„ %2 ms ëŒ€ê¸°ì‹œê°„ %3 ms",
    "args0":[
      {
        "type":"field_dropdown","name":"PITCH",
        "options":(function(){
          var KR=["ë„","ë ˆ","ë¯¸","íŒŒ","ì†”","ë¼","ì‹œ"], EN=["C","D","E","F","G","A","B"], L=[];
          for(var o=4;o<=6;o++) for(var i=0;i<7;i++) L.push([KR[i]+o, EN[i]+o]);
          return L;
        })()
      },
      {"type":"input_value","name":"DUR","check":"Number"},
      {"type":"input_value","name":"WAIT","check":"Number"}
    ],
    "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":300
  },
  {
    "type":"led_ctrl",
    "message0":"LED %1 ëª¨ë“œ %2 ê°’ %3",
    "args0":[
      {"type":"field_dropdown","name":"TGT","options":LED_TGT},
      {"type":"field_dropdown","name":"MODE","options":LED_MODE},
      {"type":"field_dropdown","name":"VAL","options":LED_VALS}
    ],
    "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":330
  },
  {
    "type":"wait_seconds",
    "message0":"%1 ì´ˆ ê¸°ë‹¤ë¦¬ê¸°",
    "args0":[{"type":"input_value","name":"SEC","check":"Number"}],
    "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":120
  }
]);

/* ================= ì½”ë“œ ë¹Œë” ================= */
function numFromInput(parent, name, def){
  if (def===void 0) def=0;
  var raw = Blockly.JavaScript.valueToCode(parent, name, Blockly.JavaScript.ORDER_NONE);
  var n = Number(raw != null ? raw : '');
  return (isFinite(n) ? n : def);
}
function walkNode(b, list){
  if(!b) return;
  switch(b.type){
    case 'motor12_dd':{
      var v1=+b.getFieldValue('M1'),v2=+b.getFieldValue('M2'),ms=+b.getFieldValue('MS');
      list.push({type:'CMD',s:'M12 '+v1+' '+v2+' '+ms});
      if(ms>0) list.push({type:'W',args:[ms]});
      break;
    }
    case 'motor12_in':{
      var v1n=numFromInput(b,'M1',0),
          v2n=numFromInput(b,'M2',0),
          msn=numFromInput(b,'MS',0);
      list.push({type:'CMD',s:'M12 '+Math.round(v1n)+' '+Math.round(v2n)+' '+Math.round(msn)});
      if(msn>0) list.push({type:'W',args:[msn]});
      break;
    }
    case 'melody':{
      var p=b.getFieldValue('PITCH'),
          dur=numFromInput(b,'DUR',200),
          wait=numFromInput(b,'WAIT',0);
      list.push({type:'CMD',s:'MEL '+p+' '+Math.round(dur)+' '+Math.round(wait)});
      if(wait>0) list.push({type:'W',args:[wait]});
      break;
    }
    case 'led_ctrl':{
      var t=b.getFieldValue('TGT'),
          m=b.getFieldValue('MODE'),
          v=+b.getFieldValue('VAL');
      list.push({type:'CMD',s:'LED '+t+' '+m+' '+v});
      break;
    }
    case 'controls_repeat_ext':{
      var times=Math.max(0, numFromInput(b,'TIMES',1));
      var inner=[];
      var first=b.getInputTargetBlock('DO');
      walkChain(first, inner);
      list.push({type:'FOR',count:times,body:inner});
      break;
    }
    case 'wait_seconds':{
      var s=numFromInput(b,'SEC',1);
      if(s>0) list.push({type:'W',args:[s*1000]});
      break;
    }
  }
}
function walkChain(start, list){
  for(var n=start; n; n=n.getNextBlock()) walkNode(n, list);
}
function normalizeProgram(list){
  var out=[];
  for(var i=0;i<list.length;i++){
    var ins=list[i];
    if(ins.type==='CMD'){
      var prev=out[out.length-1];
      if(prev && prev.type==='CMD' && prev.s===ins.s) continue;
    }else if(ins.type==='W'){
      if(!isFinite(ins.args && ins.args[0]) || ins.args[0]<=0) continue;
      var prevw=out[out.length-1];
      if(prevw && prevw.type==='W'){
        prevw.args[0]+=ins.args[0];
        continue;
      }
    }
    out.push(ins);
  }
  return out;
}

/* ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì—ì„œ ì´ë²¤íŠ¸ í”„ë¡œê·¸ë¨ ë¹Œë“œ */
function buildEventPrograms(){
  var map = {};
  var evs = ws.getBlocksByType('xrobo_start', true);
  for(var i=0;i<evs.length;i++){
    var block = evs[i];
    var key = block.getFieldValue('EVT');
    if(!key) continue;
    var chain = block.getNextBlock();
    if(!chain) continue;
    var prog=[];
    walkChain(chain, prog);
    var norm = normalizeProgram(prog);
    var label = GYRO_EVENT_LABELS[key] || key;
    if(!map[key]) map[key] = { label: label, list: [] };
    map[key].list = map[key].list.concat(norm);
  }
  return map;
}

/* ================= í—¤ë”/ìŠ¤ì¼€ì¼/í’€ìŠ¤í¬ë¦° ================= */
function applyHeaderHeight(){
  var px = document.getElementById('appHeader').offsetHeight || 64;
  document.documentElement.style.setProperty('--headerH', px+'px');
  setTimeout(function(){ Blockly.svgResize(ws); }, 60);
}
function applyUiScaleFromWorkspace(){
  var s = Math.max(.7, Math.min(1.6, ws.getScale()));
  document.documentElement.style.setProperty('--uiScale', s);
  applyHeaderHeight();
}
window.addEventListener('resize', applyHeaderHeight);
document.addEventListener('fullscreenchange', applyHeaderHeight);
ws.addChangeListener(function(ev){
  if(ev && ev.type===Blockly.Events.UI && ev.element==='zoom'){ applyUiScaleFromWorkspace(); }
});
setInterval(function(){ applyUiScaleFromWorkspace(); }, 200);
applyHeaderHeight();

/* ================= BLE & ë¡œê·¸ ================= */
var SERVICE_UUID=0xFFF0;
var bleDevice=null,bleServer=null,bleService=null,writeChar=null,notifyChar=null;
var isConnected=false, isRunning=false, isFullscreenRun=false;
var $=id=>document.getElementById(id);
var log=function(m){
  var L=$('log');
  L.textContent+=m+"\n";
  L.scrollTop=L.scrollHeight;
};
var dot=$('statusDot');
var btnConnect=$('connectToggle'), btnRun=$('runToggle'), btnTest=$('testBtn');

var enc = s=> new TextEncoder().encode(s);

function resetBleRefs(){ bleDevice=null; bleServer=null; bleService=null; writeChar=null; notifyChar=null; }
function setConnected(v){
  isConnected=v;
  btnConnect.textContent=v?'í•´ì œ':'ì—°ê²°';
  dot.classList.toggle('on',v);
  dot.classList.toggle('off',!v);
  dot.textContent=v?'on':'off';
  if(!v) setRunning(false);
}

/* ================= ìì´ë¡œ/ì„¼ì„œ ìƒíƒœ & UI ================= */
var gyroSupported = ('DeviceOrientationEvent' in window);
var gyroPermissionState = 'unknown'; // 'unknown' | 'granted' | 'denied' | 'not_supported'
var gyroOrientationListenerAdded = false;
var gyroBaselineBeta = 0;
var gyroBaselineGamma = 0;
var gyroBaselineSet = false;
var pendingGyroCalibration = false;

var GYRO_MAX_TILT = 25; // deg for full deflection
var GYRO_DEAD_ZONE = 4; // deg dead-zone
var GYRO_HIT_THRESHOLD = 0.6; // ë¹„ìœ¨ ê¸°ì¤€: 0~1

var gyroContactState = {front:false, back:false, left:false, right:false};

/* í˜„ì¬ í™”ë©´ íšŒì „ ê°ë„(0/90/180/270) */
function getScreenAngle(){
  var angle = 0;
  try{
    if(window.screen && screen.orientation && typeof screen.orientation.angle === 'number'){
      angle = screen.orientation.angle || 0;
    }else if(typeof window.orientation === 'number'){
      angle = window.orientation || 0;
    }
  }catch(e){
    angle = 0;
  }
  angle = ((angle % 360) + 360) % 360;
  if(angle >= 315 || angle < 45) return 0;
  if(angle >= 45 && angle < 135) return 90;
  if(angle >= 135 && angle < 225) return 180;
  return 270;
}
var lastScreenAngle = getScreenAngle();

/* ì´ë²¤íŠ¸ ë¼ë²¨ ì–»ê¸° */
function labelForEventKey(key){
  return (eventPrograms && eventPrograms[key] && eventPrograms[key].label) ||
         GYRO_EVENT_LABELS[key] || key;
}

/* ì´ë²¤íŠ¸ ë°œìƒ í‘œì‹œ (ìš°ì¸¡ íŒ¨ë„ + ì „ì²´í™”ë©´) */
function showEventOnUI(key){
  var label = labelForEventKey(key);
  var text = 'ì´ë²¤íŠ¸: ' + label;
  var panel = $('gyroEventText');
  if(panel) panel.textContent = text;
  var overlay = $('overlayGyroEventText');
  if(overlay) overlay.textContent = text;
}

/* ìì´ë¡œ ìƒíƒœ í…ìŠ¤íŠ¸ */
function updateGyroStatus(message){
  var text;
  if(typeof message === 'string'){
    text = message;
  }else{
    if(!gyroSupported){
      text = 'ì´ ê¸°ê¸°ëŠ” ìì´ë¡œ/ê¸°ìš¸ê¸° ì„¼ì„œë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
    }else if(gyroPermissionState === 'denied'){
      text = 'ë¸Œë¼ìš°ì €ì—ì„œ ìì´ë¡œ ì„¼ì„œ ì‚¬ìš©ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.';
    }else{
      text = 'í…ŒìŠ¤íŠ¸í•˜ê¸° ì „ì— ìì´ë¡œ ì„¼ì„œ í™”ë©´ì— ìˆ˜í‰ì„ ë§ì¶”ê³  í…ŒìŠ¤íŠ¸ë‚˜ ì‹¤í–‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.';
    }
  }
  var el1 = $('gyroStatus');
  var el2 = $('overlayGyroStatus');
  if(el1) el1.textContent = text;
  if(el2) el2.textContent = text;
}

/* ì‹¤í–‰ ìƒíƒœì— ë”°ë¼ ìì´ë¡œ ìƒíƒœ/ë©”ì‹œì§€ ì—…ë°ì´íŠ¸ */
function updateGyroRunningState(isOn){
  var status1 = $('gyroStatus');
  var status2 = $('overlayGyroStatus');
  var e1 = $('gyroEventText');
  var e2 = $('overlayGyroEventText');

  if(!isOn){
    if(status1) status1.style.display = '';
    if(status2) status2.style.display = '';
    updateGyroStatus(); // ê¸°ë³¸ ì•ˆë‚´ ë¬¸êµ¬ ë³µì›
  }else{
    if(status1) status1.style.display = 'none';
    if(status2) status2.style.display = 'none';
  }
  if(e1) e1.textContent = 'ëŒ€ê¸° ì¤‘';
  if(e2) e2.textContent = 'ëŒ€ê¸° ì¤‘';
}

/* íŒŒë€ ê³µ ìœ„ì¹˜ ê°±ì‹  (normX, normY: -1 ~ 1) */
function updateGyroBallUI(normX, normY){
  var views = [
    {areaId:'gyroArea', ballId:'gyroBall'},
    {areaId:'overlayGyroArea', ballId:'overlayGyroBall'}
  ];
  for(var i=0;i<views.length;i++){
    var area = $(views[i].areaId);
    var ball = $(views[i].ballId);
    if(!area || !ball) continue;
    var rect = area.getBoundingClientRect();
    var size = Math.min(rect.width || 0, rect.height || 0);
    if(size <= 0) continue;
    var maxOffset = size * 0.28; // ì¤‘ì•™ì—ì„œ ëª©í‘œ ì› ì¤‘ì‹¬ê¹Œì§€ ì •ë„
    var x = maxOffset * normX;
    var y = maxOffset * normY;
    ball.style.transform = 'translate(-50%, -50%) translate(' + x.toFixed(1) + 'px,' + y.toFixed(1) + 'px)';
  }
}

/* íˆ¬ëª… ê³µ í•˜ì´ë¼ì´íŠ¸ */
function highlightTarget(dir, on){
  var ids = null;
  if(dir === 'front') ids = ['gyroTargetFront','overlayGyroTargetFront'];
  else if(dir === 'back') ids = ['gyroTargetBack','overlayGyroTargetBack'];
  else if(dir === 'left') ids = ['gyroTargetLeft','overlayGyroTargetLeft'];
  else if(dir === 'right') ids = ['gyroTargetRight','overlayGyroTargetRight'];
  if(!ids) return;
  ids.forEach(function(id){
    var el = $(id);
    if(!el) return;
    el.classList.toggle('active', !!on);
  });
}

/* ìì´ë¡œ / ë²„íŠ¼ ì´ë²¤íŠ¸ â†’ ë¸”ë¡ ì‹¤í–‰ */
function fireGyroLogicalEvent(key){
  if(!isRunning) return;
  showEventOnUI(key);
  var label = labelForEventKey(key);
  log('ğŸ® ì„¼ì„œ ì´ë²¤íŠ¸: '+label+' ('+key+')');
  triggerEvent(key);
}
function fireGyroDirectionEvent(dir){
  var key = null;
  if(dir==='front') key='tilt_front';
  else if(dir==='back') key='tilt_back';
  else if(dir==='left') key='tilt_left';
  else if(dir==='right') key='tilt_right';
  if(key) fireGyroLogicalEvent(key);
}

/* ê¸°ìš¸ê¸°ì—ì„œ ì´ë²¤íŠ¸ ì¡°ê±´ ì²´í¬ */
function updateGyroContactState(normX, normY){
  var newFront = normY <= -GYRO_HIT_THRESHOLD;
  var newBack  = normY >=  GYRO_HIT_THRESHOLD;
  var newLeft  = normX <= -GYRO_HIT_THRESHOLD;
  var newRight = normX >=  GYRO_HIT_THRESHOLD;

  if(newFront !== gyroContactState.front){
    gyroContactState.front = newFront;
    highlightTarget('front', newFront);
    if(newFront) fireGyroDirectionEvent('front');
  }
  if(newBack !== gyroContactState.back){
    gyroContactState.back = newBack;
    highlightTarget('back', newBack);
    if(newBack) fireGyroDirectionEvent('back');
  }
  if(newLeft !== gyroContactState.left){
    gyroContactState.left = newLeft;
    highlightTarget('left', newLeft);
    if(newLeft) fireGyroDirectionEvent('left');
  }
  if(newRight !== gyroContactState.right){
    gyroContactState.right = newRight;
    highlightTarget('right', newRight);
    if(newRight) fireGyroDirectionEvent('right');
  }
}

/* ë””ë°”ì´ìŠ¤ ê¸°ìš¸ê¸° ì½œë°±
   - ì„¸ë¡œ/ê°€ë¡œ(0/90/180/270ë„)ë¥¼ êµ¬ë¶„í•´ì„œ
   - í•­ìƒ "í™”ë©´ì˜ ìœ„ìª½"ì´ ì´ë²¤íŠ¸ ìƒì˜ "ì•ìª½"ì´ ë˜ë„ë¡ ì¢Œí‘œ ë³€í™˜
   - ì•/ë’¤ê°€ ë°˜ëŒ€ë¡œ ëŠê»´ì ¸ì„œ forward0 ë¶€í˜¸ë¥¼ ë’¤ì§‘ì–´ ì‚¬ìš© */
function handleDeviceOrientation(event){
  if(!event) return;
  var beta = typeof event.beta === 'number' ? event.beta : null;   // ì•/ë’¤
  var gamma = typeof event.gamma === 'number' ? event.gamma : null; // ì¢Œ/ìš°
  if(beta === null || gamma === null) return;

  var angle = getScreenAngle();
  if(angle !== lastScreenAngle){
    lastScreenAngle = angle;
    gyroBaselineSet = false;
    pendingGyroCalibration = true;
    updateGyroStatus('í™”ë©´ ë°©í–¥ì´ ë°”ë€Œì—ˆìŠµë‹ˆë‹¤. ê¸°ê¸°ë¥¼ ìˆ˜í‰ìœ¼ë¡œ ë‘ì–´ ê¸°ì¤€ì ì„ ë‹¤ì‹œ ì„¤ì •í•©ë‹ˆë‹¤.');
  }

  if(pendingGyroCalibration){
    pendingGyroCalibration = false;
    gyroBaselineBeta = beta;
    gyroBaselineGamma = gamma;
    gyroBaselineSet = true;
    log('ğŸ¯ ìì´ë¡œ ê¸°ì¤€ì  ì„¤ì •: beta='+beta.toFixed(1)+', gamma='+gamma.toFixed(1));
    updateGyroBallUI(0,0);
    gyroContactState.front = gyroContactState.back = gyroContactState.left = gyroContactState.right = false;
  }
  if(!isRunning || !gyroBaselineSet) return;

  var dBeta = beta - gyroBaselineBeta;
  var dGamma = gamma - gyroBaselineGamma;

  // portrait(0ë„) ê¸°ì¤€ì—ì„œ dBeta ë°©í–¥ì´ ì‹¤ì œ ì•/ë’¤ì™€ ë°˜ëŒ€ë¡œ ëŠê»´ì ¸ì„œ ë¶€í˜¸ë¥¼ ë°˜ëŒ€ë¡œ ì‚¬ìš©
  var forward0 = -dBeta; // ì•/ë’¤
  var side0 = dGamma;    // ì¢Œ/ìš°
  var forward, side;

  // í™”ë©´ íšŒì „ì— ë”°ë¥¸ ì¢Œí‘œ ë³€í™˜ (ë²¡í„° íšŒì „)
  if(angle === 0){
    side = side0;
    forward = forward0;
  }else if(angle === 90){        // ê°€ë¡œ(í™”ë©´ ìœ„ê°€ ì›ë˜ ì˜¤ë¥¸ìª½)
    side = forward0;             // x' = y
    forward = -side0;            // y' = -x
  }else if(angle === 180){       // ìœ„ì•„ë˜ ë°˜ì „
    side = -side0;
    forward = -forward0;
  }else{                         // 270: ê°€ë¡œ ë°˜ëŒ€(í™”ë©´ ìœ„ê°€ ì›ë˜ ì™¼ìª½)
    side = -forward0;            // x' = -y
    forward = side0;             // y' = x
  }

  // forward > 0 ì´ë©´ "í™”ë©´ì˜ ìœ„ìª½ ë°©í–¥ìœ¼ë¡œ ê¸°ìš¸ì„"ì´ë¼ê³  ë³´ê³ 
  // normYëŠ” ìœ„ê°€ ìŒìˆ˜ì´ë¯€ë¡œ -forward ì‚¬ìš©
  var normX = side / GYRO_MAX_TILT;
  var normY = -forward / GYRO_MAX_TILT;

  if(Math.abs(side) < GYRO_DEAD_ZONE) normX = 0;
  if(Math.abs(forward) < GYRO_DEAD_ZONE) normY = 0;

  if(normX > 1) normX = 1; else if(normX < -1) normX = -1;
  if(normY > 1) normY = 1; else if(normY < -1) normY = -1;

  updateGyroBallUI(normX, normY);
  updateGyroContactState(normX, normY);
}

function setupOrientationListener(){
  if(gyroOrientationListenerAdded || !gyroSupported) return;
  window.addEventListener('deviceorientation', handleDeviceOrientation, true);
  gyroOrientationListenerAdded = true;
}

/* iOS ê¶Œí•œ + ì¼ë°˜ ë¸Œë¼ìš°ì € ì§€ì› */
async function ensureGyroPermission(){
  if(!gyroSupported){
    gyroPermissionState = 'not_supported';
    updateGyroStatus();
    return false;
  }
  try{
    if(typeof DeviceOrientationEvent !== 'undefined' &&
       typeof DeviceOrientationEvent.requestPermission === 'function'){
      if(gyroPermissionState === 'granted'){
        setupOrientationListener();
        return true;
      }
      var res = await DeviceOrientationEvent.requestPermission();
      gyroPermissionState = res === 'granted' ? 'granted' : 'denied';
      if(gyroPermissionState === 'granted'){
        setupOrientationListener();
        return true;
      }
      updateGyroStatus();
      log('âš ï¸ ìì´ë¡œ ê¶Œí•œ ê±°ë¶€: '+res);
      return false;
    }else{
      gyroPermissionState = 'granted';
      setupOrientationListener();
      return true;
    }
  }catch(e){
    gyroPermissionState = 'denied';
    updateGyroStatus();
    log('âš ï¸ ìì´ë¡œ ê¶Œí•œ ì˜¤ë¥˜: '+e);
    return false;
  }
}

/* í…ŒìŠ¤íŠ¸/ì‹¤í–‰ ì‹œ ìì´ë¡œ ì¤€ë¹„ */
async function prepareGyroForRun(modeLabel){
  var ok = await ensureGyroPermission();
  pendingGyroCalibration = ok;     // ê¶Œí•œì´ ìˆìœ¼ë©´ ë‹¤ìŒ ê¸°ìš¸ê¸°ì—ì„œ ê¸°ì¤€ì  ì„¤ì •
  gyroBaselineSet = false;
  gyroContactState.front = gyroContactState.back = gyroContactState.left = gyroContactState.right = false;
  updateGyroBallUI(0,0);
  if(!ok){
    updateGyroStatus('ìì´ë¡œ ê¶Œí•œ ì—†ìŒ: ê¸°ìš¸ê¸° ì´ë²¤íŠ¸ ì—†ì´ ë¸”ë¡ë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.');
  }
}

/* ì´ˆê¸° ìì´ë¡œ UI/ë²„íŠ¼ ì—°ê²° */
function initGyroSystem(){
  updateGyroStatus();
  updateGyroBallUI(0,0);

  var b1 = $('gyroBtn1');
  if(b1) b1.addEventListener('click', function(e){
    e.stopPropagation();
    fireGyroLogicalEvent('btn1');
  });
  var b2 = $('gyroBtn2');
  if(b2) b2.addEventListener('click', function(e){
    e.stopPropagation();
    fireGyroLogicalEvent('btn2');
  });
  var ob1 = $('overlayGyroBtn1');
  if(ob1) ob1.addEventListener('click', function(e){
    e.stopPropagation();
    fireGyroLogicalEvent('btn1');
  });
  var ob2 = $('overlayGyroBtn2');
  if(ob2) ob2.addEventListener('click', function(e){
    e.stopPropagation();
    fireGyroLogicalEvent('btn2');
  });
}

/* ì‹¤í–‰ ìƒíƒœ í† ê¸€ */
function setRunning(v){
  isRunning=v;
  btnRun.textContent = v ? 'â–  ì •ì§€' : 'ì‹¤í–‰';
  btnRun.style.background = v ? '#ef4444' : '#16a34a';
  btnTest.disabled = v;
  updateGyroRunningState(v);
}

/* BLE connect/disconnect */
function connectBLE(){
  if(!navigator.bluetooth){ alert('ì´ ë¸Œë¼ìš°ì €ëŠ” Web Bluetooth ë¯¸ì§€ì›ì…ë‹ˆë‹¤.'); return; }
  (async function(){
    try{
      var dev = await navigator.bluetooth.requestDevice({
        filters:[{ namePrefix:'XROBO' }],
        optionalServices:[SERVICE_UUID, 0xFFF3, 0xFFF4]
      });
      try{ if (bleDevice && bleDevice.removeEventListener){
        bleDevice.removeEventListener('gattserverdisconnected', onDisconnected);
      }}catch(e){}
      resetBleRefs();
      bleDevice=dev;
      if (bleDevice && bleDevice.addEventListener){
        bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
      }

      bleServer=await bleDevice.gatt.connect();
      bleService=await bleServer.getPrimaryService(SERVICE_UUID);

      try{ writeChar=await bleService.getCharacteristic(0xFFF3);}catch(e){}
      try{ notifyChar=await bleService.getCharacteristic(0xFFF4);}catch(e){}
      if(!writeChar || notifyChar==null){
        var cs=await bleService.getCharacteristics();
        for(var i=0;i<cs.length;i++){
          var ch=cs[i], p=ch.properties||{};
          if(!writeChar && (p.write||p.writeWithoutResponse)) writeChar=ch;
          if(!notifyChar && p.notify) notifyChar=ch;
        }
      }
      if(!writeChar) throw new Error('write íŠ¹ì„±ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
      if(notifyChar){
        await notifyChar.startNotifications();
        if (notifyChar.addEventListener){
          notifyChar.addEventListener('characteristicvaluechanged',function(ev){
            try{
              var v=new TextDecoder().decode(ev.target.value||new Uint8Array());
              log('â¬…ï¸ '+v.trim());
            }catch(e){}
          });
        }
      }
      setConnected(true);
      log('âœ… ì—°ê²°: '+(dev.name||'(ì´ë¦„ ì—†ìŒ)'));
    }catch(e){
      console.error(e);
      log('âŒ ì—°ê²° ì‹¤íŒ¨: '+e);
      setConnected(false);
      resetBleRefs();
    }
  })();
}
function onDisconnected(){
  log('ğŸ”Œ í•´ì œë¨');
  setConnected(false);
  resetBleRefs();
}
function disconnectBLE(){
  try{ if (bleDevice && bleDevice.gatt) bleDevice.gatt.disconnect(); }catch(e){}
  setConnected(false);
  resetBleRefs();
}
btnConnect.onclick = ()=> isConnected ? disconnectBLE() : connectBLE();

/* ================= ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ================= */
function serializeProject(){
  var xmlDom = Blockly.Xml.workspaceToDom(ws);
  var xmlText = Blockly.Xml.domToText(xmlDom);
  return JSON.stringify({type:'xrobo_project_v1', xml: xmlText}, null, 2);
}
function saveProject(){
  var data = serializeProject();
  var suggestedName = 'xrobo_project.json';
  if(window.showSaveFilePicker){
    (async function(){
      try{
        var handle = await showSaveFilePicker({
          suggestedName,
          types:[{description:'XROBO Project', accept:{'application/json':['.json']}}]
        });
        var stream = await handle.createWritable();
        await stream.write(new Blob([data], {type:'application/json'}));
        await stream.close();
        log('ğŸ’¾ ì €ì¥ ì™„ë£Œ');
      }catch(e){
        if(!(e && e.name==='AbortError')) log('âš ï¸ ì €ì¥ ì‹¤íŒ¨: '+e);
      }
    })();
  }else{
    var a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([data], {type:'application/json'}));
    a.download=suggestedName; a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); }, 1000);
    log('ğŸ’¾ ì €ì¥(ë‹¤ìš´ë¡œë“œ) ì™„ë£Œ');
  }
}
function loadProject(){
  (async function(){
    try{
      var text='';
      if(window.showOpenFilePicker){
        var arr = await showOpenFilePicker({
          types:[{description:'XROBO Project', accept:{'application/json':['.json']}}]
        });
        var handle = arr[0];
        var file = await handle.getFile();
        text = await file.text();
      }else{
        var input=document.createElement('input');
        input.type='file'; input.accept='.json,application/json';
        var pick = new Promise((res,rej)=>{
          input.onchange=()=>{ res(input.files[0]||null); };
          input.onerror=rej;
        });
        input.click();
        var file = await pick;
        if(!file) return;
        text = await file.text();
      }
      var obj = JSON.parse(text);
      if(!obj || obj.type!=='xrobo_project_v1') throw new Error('ì•Œ ìˆ˜ ì—†ëŠ” í”„ë¡œì íŠ¸ í˜•ì‹');
      ws.clear();
      var parser = new DOMParser();
      var xml = parser.parseFromString(obj.xml, 'text/xml');
      Blockly.Xml.domToWorkspace(xml.documentElement, ws);
      log('ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ');
    }catch(e){
      if(!(e && e.name==='AbortError')) alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+e);
    }
  })();
}

/* ================= ì˜¤ë¥¸ìª½ íŒ¨ë„: ë¡œê·¸ ë¦¬ì‚¬ì´ì € ================= */
(function(){
  var divider = document.getElementById('rightDivider');
  var root = document.documentElement;
  var dragging=false, startY=0, startH=0, rightH=0;
  function pxToNum(px){ return Number(String(px).replace('px',''))||0; }
  function onDown(e){
    e.preventDefault();
    dragging=true;
    startY=('touches' in e ? e.touches[0].clientY : e.clientY);
    startH=pxToNum(getComputedStyle(root).getPropertyValue('--logH'));
    rightH=document.getElementById('right').clientHeight;
    window.addEventListener('mousemove', onMove);
    window.addEventListener('touchmove', onMove, {passive:false});
    window.addEventListener('mouseup', onUp, {once:true});
    window.addEventListener('touchend', onUp, {once:true});
  }
  function onMove(e){
    if(!dragging) return;
    var y=('touches' in e ? e.touches[0].clientY : e.clientY);
    if('touches' in e) e.preventDefault();
    var delta = startY - y;
    var nh = startH + delta;
    // ê±°ì˜ ëê¹Œì§€ ê°ˆ ìˆ˜ ìˆë„ë¡ ë²”ìœ„ ë„“ê²Œ (ìœ„/ì•„ë˜ ì¼ë¶€ ì˜ë ¤ë„ í—ˆìš©)
    var minH=20;
    var maxH=Math.max(minH+10, rightH - 20); // ìœ„ìª½ì€ ìµœì†Œ 20px ë‚¨ê¹€
    nh=Math.min(maxH, Math.max(minH, nh));
    root.style.setProperty('--logH', nh+'px');
  }
  function onUp(){
    dragging=false;
    window.removeEventListener('mousemove', onMove);
    window.removeEventListener('touchmove', onMove);
  }
  divider.addEventListener('mousedown', onDown);
  divider.addEventListener('touchstart', onDown, {passive:false});
})();

/* ================= íŒ¨ë„ í† ê¸€ & ì „ì²´í™”ë©´ ë²„íŠ¼ ================= */
var panelHandle=document.getElementById('panelHandle');
function syncHandle(){
  var collapsed = document.body.classList.contains('panel-collapsed');
  panelHandle.classList.toggle('open',   !collapsed);
  panelHandle.classList.toggle('closed',  collapsed);
  panelHandle.title = collapsed ? 'ì‹¤í–‰ì°½ ì—´ê¸°' : 'ì‹¤í–‰ì°½ ë‹«ê¸°';
}
function togglePanel(){
  document.body.classList.toggle('panel-collapsed');
  syncHandle();
  setTimeout(()=>{ Blockly.svgResize(ws); },60);
}
panelHandle.addEventListener('click', togglePanel);
syncHandle();

var fsBtn=document.getElementById('fsBtn');
async function enterFS(){
  var el=document.documentElement;
  if(el.requestFullscreen) await el.requestFullscreen();
}
async function exitFS(){
  if(document.fullscreenElement && document.exitFullscreen) await document.exitFullscreen();
}
function syncFSLabel(){
  var a = !!document.fullscreenElement;
  document.body.classList.toggle('fs-active', a);
  fsBtn.textContent = a ? 'í™”ë©´ì¶•ì†Œ' : 'ì „ì²´í™”ë©´';
  fsBtn.title = a ? 'í™”ë©´ ì¶•ì†Œë¡œ ì „í™˜' : 'ì „ì²´í™”ë©´ìœ¼ë¡œ ì „í™˜';
  applyHeaderHeight();
}
fsBtn.onclick=async function(){
  if(document.fullscreenElement) await exitFS(); else await enterFS();
};
document.addEventListener('fullscreenchange', syncFSLabel);
syncFSLabel();

/* ================= ì‹¤í–‰/í & ì´ë²¤íŠ¸ ë§¤í•‘ ================= */
var eventPrograms = {};
var queue = [];
var queueBusy = false;
var cancelToken = 0;

function sendRaw(s){
  if(!writeChar){
    log('â¡ï¸(BLE ë¯¸ì—°ê²°) '+s);
    return Promise.resolve();
  }
  return writeChar.writeValue(enc(s+'\n'))
    .then(()=>{ log('â¡ï¸ '+s); })
    .catch(e=>{ log('âš ï¸ ì „ì†¡ ì‹¤íŒ¨: '+e); });
}
async function runList(list, localToken){
  for(var i=0;i<list.length;i++){
    var ins=list[i];
    if(localToken !== cancelToken) return;
    if(ins.type==='CMD'){
      await sendRaw(ins.s);
    }else if(ins.type==='W'){
      var ms = (ins.args && ins.args[0]) ? ins.args[0] : 0;
      if(ms>0) await new Promise(r=>setTimeout(r, ms));
    }else if(ins.type==='FOR'){
      for(var k=0;k<ins.count;k++){
        if(localToken !== cancelToken) return;
        await runList(ins.body, localToken);
      }
    }
  }
}
async function processQueue(localToken){
  if(queueBusy) return;
  queueBusy = true;
  try{
    while(queue.length && localToken === cancelToken){
      var item = queue.shift();
      await runList(item.list, localToken);
    }
  }finally{
    queueBusy = false;
  }
}

function triggerEvent(key){
  if(!isRunning) return;
  var entry = eventPrograms[key];
  showEventOnUI(key);
  if(!entry || !entry.list || !entry.list.length) return;
  queue.push({list: entry.list});
  log('â–¶ ì´ë²¤íŠ¸ ì‹¤í–‰: "'+ (entry.label || key) + '"');
  var myToken = cancelToken;
  processQueue(myToken);
}

/* í…ŒìŠ¤íŠ¸ ì‹¤í–‰ */
async function startTest(){
  if(isRunning) return;
  eventPrograms = buildEventPrograms();
  cancelToken++; queue = [];
  isFullscreenRun = false;
  await prepareGyroForRun('í…ŒìŠ¤íŠ¸');
  setRunning(true);
  log('â–¶ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤€ë¹„ ì™„ë£Œ (ìì´ë¡œ/ë²„íŠ¼ ì´ë²¤íŠ¸ ëŒ€ê¸°)');
}

/* ì „ì²´í™”ë©´ ì‹¤í–‰ */
var overlay = document.getElementById('playOverlay');
async function startFullRun(){
  if(isRunning) return;
  eventPrograms = buildEventPrograms();
  cancelToken++; queue = [];
  isFullscreenRun = true;
  await prepareGyroForRun('ì‹¤í–‰');

  setRunning(true);

  overlay.classList.add('show');
  overlay.setAttribute('aria-hidden','false');
  try{
    if(overlay.requestFullscreen) await overlay.requestFullscreen();
  }catch(e){}
  log('â–¶ ì „ì²´í™”ë©´ ì‹¤í–‰ ì‹œì‘ (ìì´ë¡œ/ë²„íŠ¼ ì´ë²¤íŠ¸ ëŒ€ê¸°)');
}

/* ì •ì§€ */
async function stopRun(){
  cancelToken++; queue=[];
  setRunning(false);
  overlay.classList.remove('show');
  overlay.setAttribute('aria-hidden','true');
  isFullscreenRun = false;
  try{
    if(document.fullscreenElement) await document.exitFullscreen();
  }catch(e){}
  try{
    if(writeChar) writeChar.writeValue(enc('S\n'));
  }catch(e){}
}

btnTest.onclick = ()=> { if(!isRunning) startTest(); };
btnRun.onclick  = ()=> { if(!isRunning) startFullRun(); else stopRun(); };

document.addEventListener('fullscreenchange', ()=>{
  if (isFullscreenRun && !document.fullscreenElement){
    stopRun();
  }
});
document.addEventListener('keydown', (e)=>{
  if (isFullscreenRun && e.key === 'Escape') stopRun();
});

/* ìì´ë¡œ ì‹œìŠ¤í…œ ì´ˆê¸°í™” (DOM ì¤€ë¹„ í›„) */
initGyroSystem();

/* ================= ìŒì„± ì¸ì‹ (ê¸°ì¡´ êµ¬ì¡° ìœ ì§€, í˜„ì¬ UIëŠ” ì‚¬ìš© ì•ˆ í•¨) ================= */
var voiceBtn = document.getElementById('voiceBtn'); // ì¡´ì¬í•˜ì§€ ì•Šì•„ë„ ë¬´ì‹œë¨
var voiceStatus = document.getElementById('voiceStatus');
var voiceText = document.getElementById('voiceText');

var overlayVoiceBtn = document.getElementById('overlayVoiceBtn');
var overlayVoiceStatus = document.getElementById('overlayVoiceStatus');
var overlayVoiceText = document.getElementById('overlayVoiceText');

var recognition = null;
var recognizing = false;
var listenTimer = null;
var lastTranscript = '';

function updateVoiceUI(state, msg){
  if(voiceStatus){
    if(state === 'idle')      voiceStatus.textContent = 'ëŒ€ê¸° ì¤‘';
    else if(state === 'listening') voiceStatus.textContent = 'ë“£ëŠ” ì¤‘... (ìµœëŒ€ 3ì´ˆ)';
    else if(state === 'thinking')  voiceStatus.textContent = 'ì¸ì‹ ì¤‘...';
    else if(state === 'done')      voiceStatus.textContent = 'ì¸ì‹ ì™„ë£Œ';
    else if(state === 'error')     voiceStatus.textContent = 'ì˜¤ë¥˜';
  }
  if(overlayVoiceStatus){
    if(state === 'idle')      overlayVoiceStatus.textContent = 'ëŒ€ê¸° ì¤‘';
    else if(state === 'listening') overlayVoiceStatus.textContent = 'ë“£ëŠ” ì¤‘... (ìµœëŒ€ 3ì´ˆ)';
    else if(state === 'thinking')  overlayVoiceStatus.textContent = 'ì¸ì‹ ì¤‘...';
    else if(state === 'done')      overlayVoiceStatus.textContent = 'ì¸ì‹ ì™„ë£Œ';
    else if(state === 'error')     overlayVoiceStatus.textContent = 'ì˜¤ë¥˜';
  }

  if(typeof msg === 'string'){
    if(voiceText) voiceText.textContent = msg;
    if(overlayVoiceText) overlayVoiceText.textContent = msg;
  }
}

function ensureSpeechRecognition(){
  var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){
    return null;
  }
  if(!recognition){
    recognition = new SR();
    recognition.lang = 'ko-KR';
    recognition.interimResults = true;
    recognition.maxAlternatives = 3;

    recognition.onstart = function(){
      recognizing = true;
      if(voiceBtn) voiceBtn.classList.add('listening');
      if(overlayVoiceBtn) overlayVoiceBtn.classList.add('listening');
      updateVoiceUI('listening', 'ì§€ê¸ˆ ë§í•´ ì£¼ì„¸ìš”...');
    };
    recognition.onerror = function(e){
      recognizing = false;
      if(voiceBtn) voiceBtn.classList.remove('listening');
      if(overlayVoiceBtn) overlayVoiceBtn.classList.remove('listening');
      clearTimeout(listenTimer);
      log('âŒ ìŒì„± ì¸ì‹ ì˜¤ë¥˜: '+ (e && e.error ? e.error : e));
      updateVoiceUI('error', 'ìŒì„± ì¸ì‹ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
    };
    recognition.onresult = function(event){
      var interim='';
      var finalText='';
      for(var i=0;i<event.results.length;i++){
        var res = event.results[i];
        if(res.isFinal) finalText += res[0].transcript;
        else interim += res[0].transcript;
      }
      var display = finalText || interim;
      if(display){
        updateVoiceUI('listening', display);
        lastTranscript = display;
      }
    };
    recognition.onend = function(){
      recognizing = false;
      if(voiceBtn) voiceBtn.classList.remove('listening');
      if(overlayVoiceBtn) overlayVoiceBtn.classList.remove('listening');
      clearTimeout(listenTimer);
      if(lastTranscript){
        updateVoiceUI('done', lastTranscript);
        handleVoiceCommand(lastTranscript);
      }else{
        updateVoiceUI('idle', 'ì¸ì‹ëœ ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
      }
    };
  }
  return recognition;
}

function startVoiceRecognition(){
  var rec = ensureSpeechRecognition();
  if(!rec) return;
  if(recognizing){
    try{ rec.stop(); }catch(e){}
    return;
  }
  lastTranscript = '';
  try{
    rec.start();
    updateVoiceUI('listening', 'ì§€ê¸ˆ ë§í•´ ì£¼ì„¸ìš”...');
    listenTimer = setTimeout(function(){
      try{ rec.stop(); }catch(e){}
    }, 3000);
  }catch(e){
    log('âš ï¸ ìŒì„± ì¸ì‹ ì‹œì‘ ì‹¤íŒ¨: '+e);
    updateVoiceUI('error', 'ìŒì„± ì¸ì‹ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }
}
if(voiceBtn) voiceBtn.addEventListener('click', startVoiceRecognition);
if(overlayVoiceBtn) overlayVoiceBtn.addEventListener('click', startVoiceRecognition);

/* ì „ì²´í™”ë©´ì—ì„œ ë‘ ë²ˆ íƒ­í•˜ë©´ ì¢…ë£Œ */
(function(){
  if(!overlay) return;
  var lastTapTime = 0;
  overlay.addEventListener('pointerdown', function(e){
    var now = e.timeStamp || Date.now();
    if(now - lastTapTime <= 300){
      stopRun();
      lastTapTime = 0;
    }else{
      lastTapTime = now;
    }
  }, {passive:true});
  overlay.addEventListener('dblclick', function(){
    stopRun();
  }, {passive:true});
})();

/* ìŒì„± ê²°ê³¼ â†’ ì´ë²¤íŠ¸ ë§¤ì¹­ (í˜„ì¬ëŠ” ì•ˆë‚´ë§Œ) */
function handleVoiceCommand(text){
  var key = (text || '').toLowerCase().replace(/\s+/g,'');
  if(!key){
    log('ğŸ™ ì¸ì‹ ê²°ê³¼ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
    return;
  }
  log('ğŸ™ ì¸ì‹ ë¬¸ì¥: "'+ text + '"');

  if(!isRunning){
    log('â„¹ï¸ ì•„ì§ ì‹¤í–‰ ëª¨ë“œê°€ ì•„ë‹™ë‹ˆë‹¤. [í…ŒìŠ¤íŠ¸] ë˜ëŠ” [ì‹¤í–‰] ë²„íŠ¼ì„ ë¨¼ì € ëˆŒëŸ¬ ì£¼ì„¸ìš”.');
    return;
  }

  log('â„¹ï¸ í˜„ì¬ í”„ë¡œì íŠ¸ëŠ” ìì´ë¡œ/ë²„íŠ¼ ì´ë²¤íŠ¸ ì „ìš©ì…ë‹ˆë‹¤. ìŒì„± ì´ë²¤íŠ¸ëŠ” ë§¤í•‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
}

/* ================= ë ================= */
</script>

<script id="xrobo-hsplit-script">
(function(){
  var res = document.getElementById('hResizer');
  var main = document.getElementById('main');
  var right = document.getElementById('right');
  if(!res || !main || !right) return;

  var dragging = false;
  var startX = 0;
  var startW = 0;
  var rafId = 0;
  var maxW = 0;

  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

  function computeMax(){
    var rect = main.getBoundingClientRect();
    var barW = res.getBoundingClientRect().width || 8;
    maxW = Math.max(0, rect.width - barW);
    return maxW;
  }

  function onDown(clientX){
    dragging = true;
    startX = clientX;
    startW = right.getBoundingClientRect().width;
    computeMax();
    document.body.classList.add('hs-resizing');
  }

  function applyWidth(newW){
    newW = clamp(newW, 0, maxW);
    document.documentElement.style.setProperty('--rightW', newW + 'px');
    cancelAnimationFrame(rafId);
    rafId = requestAnimationFrame(function(){
      try{
        if (window.Blockly && typeof Blockly.svgResize==='function' && window.ws) {
          Blockly.svgResize(ws);
        }
      }catch(e){}
    });
  }

  function onMove(clientX){
    if(!dragging) return;
    var dx = clientX - startX;
    var newW = startW - dx;
    applyWidth(newW);
  }

  function onUp(){
    dragging = false;
    document.body.classList.remove('hs-resizing');
  }

  res.addEventListener('mousedown', function(e){ e.preventDefault(); onDown(e.clientX); });
  window.addEventListener('mousemove', function(e){ onMove(e.clientX); });
  window.addEventListener('mouseup', onUp);

  res.addEventListener('touchstart', function(e){
    if(!e.touches || !e.touches[0]) return;
    e.preventDefault();
    onDown(e.touches[0].clientX);
  }, {passive:false});
  window.addEventListener('touchmove', function(e){
    if(!e.touches || !e.touches[0]) return;
    onMove(e.touches[0].clientX);
  }, {passive:false});
  window.addEventListener('touchend', onUp);

  document.body.classList.remove('panel-collapsed');

  window.addEventListener('resize', function(){
    var cur = right.getBoundingClientRect().width;
    var mx = computeMax();
    if(cur > mx) applyWidth(mx);
  });
})();

/* === íŒŒì¼ ë“œë¡­ë‹¤ìš´ ë¡œì§(ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°) === */
(function(){
  var btn  = document.getElementById('fileBtn');
  var menu = document.getElementById('fileMenu');
  if(!btn || !menu) return;
  btn.addEventListener('click', function(e){
    e.stopPropagation();
    menu.classList.toggle('show');
    menu.setAttribute('aria-hidden', menu.classList.contains('show') ? 'false' : 'true');
  });
  document.addEventListener('click', function(){
    menu.classList.remove('show');
    menu.setAttribute('aria-hidden','true');
  });
  menu.addEventListener('click', function(e){
    var t = e.target;
    if(!t || !t.getAttribute) return;
    var cmd = t.getAttribute('data-cmd');
    if(!cmd) return;
    try{
      if(cmd==='save'){ if(typeof saveProject==='function') saveProject(); }
      else if(cmd==='load'){ if(typeof loadProject==='function') loadProject(); }
    }catch(_){}
    menu.classList.remove('show');
    menu.setAttribute('aria-hidden','true');
  });
})();

/* === ìƒˆë¡œë§Œë“¤ê¸° === */
(function(){
  var menu = document.getElementById('fileMenu');
  if(!menu) return;
  if(menu.__x_new_bound) return;
  menu.__x_new_bound = true;
  menu.addEventListener('click', function(e){
    try{
      var cmd = e && e.target && e.target.getAttribute && e.target.getAttribute('data-cmd');
      if(cmd !== 'new') return;
      if (typeof ws !== 'undefined' && ws && typeof ws.clear === 'function'){
        if(confirm('í˜„ì¬ í”„ë¡œì íŠ¸ë¥¼ ëª¨ë‘ ì§€ìš°ê³  ìƒˆë¡œ ë§Œë“¤ê¹Œìš”?')){
          try{ ws.clear(); }catch(_){}
          try{
            if(typeof multiServoConfigs !== 'undefined' && multiServoConfigs &&
               typeof multiServoConfigs.clear==='function') multiServoConfigs.clear();
          }catch(_){}
          try{ if(typeof refreshCodeDebounced === 'function') refreshCodeDebounced(); }catch(_){}
          try{ if(typeof log === 'function') log('ğŸ†• ìƒˆ í”„ë¡œì íŠ¸'); }catch(_){}
        }
      }else{
        if(confirm('í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ìƒˆë¡œ ì‹œì‘í• ê¹Œìš”?')){
          location.reload();
        }
      }
    }catch(_){}
  });
})();
</script>

<script id="xrobo-kp4x4-v14-script">
/* Androidìš© ìˆ«ì íŒ¨ë“œ + Blockly ìˆ«ì í•„ë“œ ì—°ë™ */
(function(){
  if(!/Android/i.test(navigator.userAgent||'')) { return; }

  'use strict';
  const isAndroid = /Android/i.test(navigator.userAgent||'');
  if(!isAndroid){ return; }
  const hasPointer = 'PointerEvent' in window;

  let pad, disp, grid;
  let activeInput = null;   // ê¸°ì¡´: servoModal ë“±ì˜ <input>
  let activeField = null;   // ì¶”ê°€: Blockly FieldNumber
  let buffer = '';
  let rafId = 0;
  let lastAnchor = {x: window.innerWidth/2, y: 140};
  let outsideBound = false;
  let committing = false;
  let lastPressLabel = '';
  let lastPressTime = 0;
  const PRESS_DEBOUNCE_MS = 160;

  function safeEval(expr){
    if(typeof expr!=='string') return NaN;
    expr = expr.replace(/[^0-9+\-*/\s]/g,'').trim();
    if(!expr) return NaN;
    const tokens = expr.match(/(\d+|[+\-*/])/g) || [];
    if(tokens.length===0) return NaN;
    const values=[], ops=[];
    let expectNum=true, unary=null;
    function prec(op){ return (op==='*'||op==='/')?2:1; }
    function apply(){
      const op=ops.pop(), b=values.pop(), a=values.pop();
      values.push(op==='+'?a+b: op==='-'?a-b: op==='*'?a*b: (b===0?0:Math.trunc(a/b)));
    }
    for(const tk of tokens){
      if(/^\d+$/.test(tk)){
        let v=parseInt(tk,10); if(unary==='-') v=-v; unary=null; values.push(v); expectNum=false;
      }else{
        if(expectNum){ if(tk==='+'||tk==='-') unary=tk; }
        else{
          while(ops.length && prec(ops[ops.length-1])>=prec(tk)) apply();
          ops.push(tk); expectNum=true;
        }
      }
    }
    while(ops.length) apply();
    return values.length? values[0]:NaN;
  }
  function dispatch(el, type){
    try{ el.dispatchEvent(new Event(type, {bubbles:true})); }catch(_){}
  }

  function buildPad(){
    if(pad) return pad;
    pad = document.createElement('div');
    pad.id = 'xrobo-kp4x4-v14';
    pad.innerHTML =
      '<div class="display" aria-live="polite"></div>'+
      '<div class="grid" role="group" aria-label="ìˆ«ìíŒ¨ë“œ"></div>';
    document.body.appendChild(pad);
    disp = pad.querySelector('.display');
    grid = pad.querySelector('.grid');

    const layout = [
      {t:'1'},{t:'2'},{t:'3'},{t:'â†',cls:'back'},
      {t:'4'},{t:'5'},{t:'6'},{t:'C',cls:'clear'},
      {t:'7'},{t:'8'},{t:'9'},{t:'+',cls:'op'},
      {t:'*',cls:'op'},{t:'0'},{t:'/',cls:'op'},{t:'-',cls:'op'},
      {t:'í™•ì¸',cls:'wide ok'},{t:'ì·¨ì†Œ',cls:'wide cancel'}
    ];
    layout.forEach(k=>{
      const b=document.createElement('button');
      b.type='button';
      b.textContent=k.t;
      if(k.cls) k.cls.split(' ').forEach(c=>b.classList.add(c));
      grid.appendChild(b);
    });

    const press = (label)=>{
      const now = performance.now();
      if(label === lastPressLabel && (now - lastPressTime) < PRESS_DEBOUNCE_MS){
        return;
      }
      lastPressLabel = label; lastPressTime = now;

      if(label==='í™•ì¸'){ commit(); return; }
      if(label==='ì·¨ì†Œ'){ cancel(); return; }
      if(label==='C'){ buffer=''; sync(); return; }
      if(label==='â†'){ buffer = buffer.slice(0, buffer.length-1); sync(); return; }
      if(/^[0-9+\-*/]$/.test(label)){ buffer += label; sync(); return; }
    };

    function getButtonFromEvent(e){
      if(e.type==='touchstart' && e.touches && e.touches[0]){
        const t=e.touches[0];
        const el=document.elementFromPoint(t.clientX, t.clientY);
        return el && el.closest && el.closest('button');
      }
      return e.target && e.target.closest && e.target.closest('button');
    }

    const onPress = (e)=>{
      const btn = getButtonFromEvent(e); if(!btn) return;
      e.preventDefault(); e.stopPropagation();
      press(btn.textContent);
    };

    if(!grid.dataset.bound){
      if(hasPointer){
        grid.addEventListener('pointerdown', onPress, true);
      }else if('ontouchstart' in window){
        grid.addEventListener('touchstart', onPress, {passive:false, capture:true});
      }else{
        grid.addEventListener('mousedown', onPress, true);
      }
      grid.addEventListener('click', function(e){ e.preventDefault(); e.stopPropagation(); }, true);
      grid.dataset.bound = '1';
    }

    const outside = (e)=>{
      if(!pad.classList.contains('show')) return;
      if(pad.contains(e.target)) return;
      if(activeInput && e.target===activeInput) return;
      commit();
    };
    if(!outsideBound){
      if(hasPointer){
        document.addEventListener('pointerdown', outside, true);
      }else if('ontouchstart' in window){
        document.addEventListener('touchstart', outside, {passive:false, capture:true});
      }else{
        document.addEventListener('mousedown', outside, true);
      }
      outsideBound = true;
    }

    return pad;
  }
  function showPad(){ buildPad().classList.add('show'); }
  function hidePad(){ if(pad) pad.classList.remove('show'); }

  function positionNearRect(r){
    const br = pad.getBoundingClientRect();
    const pw=br.width, ph=br.height;
    const gap=8, vx=window.scrollX||0, vy=window.scrollY||0;
    let left=r.right + gap + vx, top=r.top + vy;
    if(left + pw > vx + innerWidth - 6){ left = r.left + vx - pw - gap; }
    if(top + ph > vy + innerHeight - 6){ top = Math.max(vy+6, vy + innerHeight - ph - 6); }
    if(top < vy + 6) top = vy + 6;
    pad.style.left = left + 'px'; pad.style.top = top + 'px';
  }
  function positionNearInput(input){ positionNearRect(input.getBoundingClientRect()); }
  function positionNearPoint(x,y){ positionNearRect({left:x, right:x, top:y, bottom:y, width:0, height:0}); }

  function startFollowInput(input){
    cancelAnimationFrame(rafId);
    const tick=()=>{
      if(activeInput){
        positionNearInput(input);
        rafId=requestAnimationFrame(tick);
      }
    };
    tick();
  }
  function stopFollow(){ cancelAnimationFrame(rafId); rafId=0; }

  function sync(){
    if(disp) disp.textContent = buffer;
    if(activeInput){
      activeInput.value = buffer;
      dispatch(activeInput,'input');
    }
  }

  function evaluateAndClamp(raw, inputEl){
    let num = safeEval(String(raw||'').trim());
    if(!Number.isFinite(num)) return { ok:false, val:String(raw||'') };
    const min = Number(inputEl?.getAttribute('min'));
    const max = Number(inputEl?.getAttribute('max'));
    if(Number.isFinite(min)) num = Math.max(min, num);
    if(Number.isFinite(max)) num = Math.min(max, num);
    return { ok:true, val:String(num) };
  }

  function commit(){
    if(committing) return;
    committing = true;
    try{
      if(activeField){
        try{
          activeField.setValue(buffer);
        }catch(_){}
        activeField = null;
      }else if(activeInput){
        const { ok, val } = evaluateAndClamp(buffer, activeInput);
        activeInput.value = val;
        dispatch(activeInput,'input');
        dispatch(activeInput,'change');
        activeInput = null;
      }
      stopFollow(); hidePad();
    }finally{
      committing = false;
    }
  }

  function cancel(){
    activeField = null;
    activeInput = null;
    stopFollow(); hidePad();
  }

  function openForInput(input){
    activeInput = input;
    activeField = null;
    buffer = String(input.value||'');
    if(isAndroid){
      input.setAttribute('readonly', 'readonly');
      input.setAttribute('inputmode','none');
      input.addEventListener('touchstart', ev=>{ ev.preventDefault(); ev.stopPropagation(); }, {capture:true, passive:false});
      setTimeout(()=>{ try{ input.blur(); }catch(_){ } }, 0);
    }
    input.setAttribute('pattern','[0-9+\\-*/]*');
    input.setAttribute('autocomplete','off');
    input.setAttribute('autocorrect','off');
    input.setAttribute('autocapitalize','off');
    input.setAttribute('spellcheck','false');

    showPad();
    positionNearInput(input);
    startFollowInput(input);
    sync();
  }

  // â˜… Blockly ìˆ«ì í•„ë“œìš©: FieldNumberì— ì§ì ‘ ì—°ê²°
  function openForField(field){
    activeField = field;
    activeInput = null;
    try{
      buffer = String(field.getValue ? field.getValue() : '');
    }catch(_){
      buffer = '';
    }
    showPad();
    try{
      const root = field.getClickTarget_ ? field.getClickTarget_()
                  : (field.getSvgRoot ? field.getSvgRoot() : null);
      if(root && root.getBoundingClientRect){
        positionNearRect(root.getBoundingClientRect());
      }else{
        positionNearPoint(lastAnchor.x, lastAnchor.y);
      }
    }catch(_){
      positionNearPoint(lastAnchor.x, lastAnchor.y);
    }
    if(disp) disp.textContent = buffer;
  }

  document.addEventListener('focusin', function(e){
    const t = e.target;
    if(!t) return;

    // Blockly í…ìŠ¤íŠ¸ ì…ë ¥ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ
    if(t.classList &&
       (t.classList.contains('blocklyHtmlInput') ||
        t.classList.contains('blocklyHtmlTextInput'))){
      return;
    }

    // servo ê´€ë ¨ ì…ë ¥ë§Œ ìˆ«ìíŒ¨ë“œ ì‚¬ìš©
    try{
      const uaOk = /Android/i.test(navigator.userAgent||'');
      if(uaOk && t.matches &&
         t.matches('#servoModal .speedbox input, #boardStage .speedbox input')){
        try{
          t.setAttribute('inputmode','none');
          t.setAttribute('autocomplete','off');
          t.setAttribute('autocorrect','off');
        }catch(_){}
        try{
          t.setAttribute('readonly','readonly');
          setTimeout(()=>{ try{ t.removeAttribute('readonly'); }catch(_){ } }, 0);
        }catch(_){}
        openForInput(t);
        const onBlur = ()=>{ try{ commit(); }catch(_){ cancel(); } t.removeEventListener('blur', onBlur); };
        t.addEventListener('blur', onBlur);
      }
    }catch(_){}
  }, true);

  /* ë§ˆì§€ë§‰ í„°ì¹˜ ìœ„ì¹˜ ì €ì¥ */
  (function(){
    const root = document.getElementById('blocklyDiv') || document.body;
    const savePt = (e)=>{ lastAnchor = {x:e.clientX, y:e.clientY}; };
    if(hasPointer) root.addEventListener('pointerdown', savePt, true);
    else{
      root.addEventListener('mousedown', savePt, true);
      root.addEventListener('touchstart', (e)=>{
        if(e.touches&&e.touches[0]) lastAnchor={x:e.touches[0].clientX, y:e.touches[0].clientY};
      }, {capture:true, passive:true});
    }
  })();

  /* === Blockly FieldNumberë¥¼ ìˆ«ìíŒ¨ë“œë¡œ ì—°ê²° === */
  function patchBlocklyNumber(){
    if(!window.Blockly || !Blockly.FieldNumber) return;
    const FN = Blockly.FieldNumber;
    const proto = FN.prototype;
    if(proto.__xrobo_kp4x4_patched) return;
    proto.__xrobo_kp4x4_patched = true;

    proto.__xrobo_kp4x4_origShowEditor = proto.showEditor_;

    proto.showEditor_ = function(){
      openForField(this);
    };
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', patchBlocklyNumber);
  }else{
    patchBlocklyNumber();
  }
  setTimeout(patchBlocklyNumber, 800);

})();
</script>
</body>
</html>
